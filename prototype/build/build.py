#!/usr/bin/python3
# given: 'gitatom/templates/default.html', 
#        'gitatom/templates/list_posts.html',
#        'site/assets/css/style.css',
#        'site/about.html', and 'site/blog.html'
#
# build.py: scans 'site/' and its subdirs, 
#           renders list_posts template (which inherits from default.html)
#
# output:   site/index.html
# run:      ./build.py

from jinja2 import Environment, FileSystemLoader
import os, stat, time


# scan 'site/' for html files 
def scan(basepath):
    posts = list() # blog posts
    nav = list()   # for navbar atop page

    for dirpath, dirname, files in os.walk(basepath):
        for f in files:

            if f.endswith('.html'):
                html = dict()
                url = os.path.join(dirpath, f)
                html['filename'] = os.path.splitext(f)[0]
                html['url'] = url.replace(basepath, '')

                # one of assumed pages that will always exist
                if f in {'index.html', 'about.html', 'blog.html'}:
                    nav.append(html)
                
                else: # page generated by parsing atom files
                    file_stats = os.stat(url)
                    modified_time = time.ctime(file_stats[ stat.ST_MTIME ])
                    html['modified'] = modified_time
                    posts.append(html)

    # sort on date modified (newest first)
    sorted_posts = sorted(posts, key=lambda post: post['modified'], reverse=True)
    return sorted_posts, nav


# fill list_posts template, return rendered html
def index(posts, nav):

    file_loader = FileSystemLoader('./gitatom/templates')
    env = Environment(loader=file_loader)

    # nav gets a list of navbar links (fills list_posts template)
    # list_posts gets a list of posts (fills inherited default template)
    template = env.get_template('list_posts.html')
    output = template.render(nav=nav, posts=posts)

    return output


# write out to site/index.html
def render(html):
        with open("site/index.html", "w") as index:
            index.write(html)
        print("\nsite/index.html was just rendered.\n")


posts, nav = scan('site/')
generated = index(posts, nav)
render(generated)
